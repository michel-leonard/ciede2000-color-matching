name: R CIEDE2000 Testing

# During summer 2025, this workflow was tested on several weekends and completed successfully in 92 seconds.

on:
  schedule:
    - cron: '44 3 2 * *'
  workflow_dispatch:

env:
  description: "Automated Testing â€” Michel Leonard implements the CIE2000 color difference formula in R"
  input_file: "test-cases.csv contains lines like 51,4.3,90,48.3,-20,116 representing two L*a*b* colors"
  process:  "Print the line with its Delta E like 51,4.3,90,48.3,-20,116,12.497294297213971744079236378547 for each line"
  related_url: "https://github.com/michel-leonard/ciede2000-color-matching/tree/main/tests/r"
  n_csv_lines: 10000000

jobs:
  test-implementation-de00-r:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“‚ For each step below, a new shell will be started at the repository root
        uses: actions/checkout@v6

      - name: ğŸ‘‰ Disable the user manual database, which is not needed in this CI/CD workflow
        run: sudo ln --backup --symbolic --verbose $(which true) $(which mandb)

      - name: ğŸ‘‰ Set up a less crowded server for the APT package manager (step disabled, but useful when an installation is slow)
        run: true || grep -Flr '.ubuntu.com' /etc/apt | xargs sudo sed -i 's|[^/]\+ubuntu.com|mirrors.maine.edu|g'

      - name: ğŸ“¦ Set up R, Rscript and gcc
        run: |
          command -v Rscript > /dev/null || {
            command -v dirmngr > /dev/null && command -v apt-add-repository > /dev/null ||
            { sudo apt-get update --allow-unauthenticated && sudo apt-get install --allow-unauthenticated --no-install-recommends --assume-yes --no-install-recommends software-properties-common dirmngr ; }
            . /etc/os-release && wget --no-verbose --no-check-certificate --timeout=5 --tries=2 https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc -O- |
            sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/cran.gpg
            echo "deb [signed-by=/etc/apt/trusted.gpg.d/cran.gpg] \
            https://cloud.r-project.org/bin/linux/ubuntu ${VERSION_CODENAME}-cran40/" |
            sudo tee /etc/apt/sources.list.d/cran.list
            sudo apt-get update --allow-unauthenticated && sudo apt-get install --allow-unauthenticated --no-install-recommends --assume-yes r-base
          }
          command -v gcc > /dev/null || { sudo apt-get update --allow-unauthenticated && sudo apt-get install --allow-unauthenticated --no-install-recommends --assume-yes gcc ; }

      - name: ğŸ”§ Install dependencies
        run: |
          Rscript -e 'cat("R version:", R.version.string, "\n")'
          # Rscript -e "install.packages('renv', repos='https://cran.r-project.org')"
          # Rscript -e "if (file.exists('renv.lock')) renv::restore()"

      - name: âš™ï¸ Compile the CIEDE2000 driver program in C99
        run: gcc --version && gcc -std=c99 -Wall -pedantic -O2 -g tests/c/ciede-2000-driver.c -o ciede-2000-driver -lm

      - name: ğŸ“‘ Display help for the authoritative test software
        run: ./ciede-2000-driver --help

      - name: ğŸ¨ Generate Î”E2000 color difference test cases
        run: |
          # Splits the large file into as many smaller files as there are vCPUs
          n_cpu=$(nproc) && ./ciede-2000-driver --rand-seed $(date +'%Y%V') --generate $n_csv_lines |
          split --unbuffered --lines=$(( ($n_csv_lines + $n_cpu - 1) / $n_cpu )) --numeric-suffixes=1 --additional-suffix=.csv - test-cases-
          # Shows the name, size and first line of newly created files
          du -h test-cases-* | awk '{getline line < $2; print $2, "(" $1 "B) contains L*a*b* color pairs for vCPU " NR ", first values =", line}'

      - name: âš¡ Solves test cases by calculating Î”E2000 in R (parallelized operation)
        run: |
          for file in test-cases-*; do
            Rscript tests/r/ciede-2000-driver.r $file > solved-$file &
            echo "Processes $file ($(wc -l < $file) lines) in parallel â¤ solved-$file"
          done
          wait

      - name: ğŸš€ Check that C99 calculations matches Râ€™s
        run: cat solved-* | ./ciede-2000-driver -o summary.txt

      - name: ğŸ” Display verification output
        run: cat summary.txt

      - name: ğŸ Conclusion
        run: |
          if grep -q "Errors : 0" summary.txt && grep -q "Successes : $n_csv_lines" summary.txt; then
            echo "âœ”ï¸ Verification successful: all $n_csv_lines color differences were correctly calculated."
          else
            echo "âŒ Verification failed. See above for details."
            exit 1
          fi
